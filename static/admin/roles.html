<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý vai trò - Admin</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/sinhvien/css/student-bs5.css" />
    <!-- Theme CSS -->
    <link rel="stylesheet" href="/css/theme.css" />
    <script src="/js/theme.js"></script>
    <link rel="stylesheet" href="/admin/css/admin.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .admin-wrapper {
        display: flex;
        min-height: 100vh;
      }
      .admin-sidebar {
        width: 260px;
        background: var(--card-bg);
        border-right: 1px solid var(--glass-border);
        flex-shrink: 0;
      }
      .admin-main {
        flex: 1;
        padding: 2rem;
        background: var(--bg-dark);
        overflow-y: auto;
      }
      .role-card {
        border-left: 4px solid var(--accent);
        transition: all 0.3s ease;
      }
      .role-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      }
      .permission-badge {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        color: var(--text-main);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        display: inline-block;
        margin: 0.25rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .perm-card {
        transition: all 0.2s ease;
      }
      .perm-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="admin-wrapper">
      <aside class="admin-sidebar shadow-sm">
        <!-- Sidebar injected by sidebar.js -->
      </aside>

      <main class="admin-main">
        <header class="mb-5 d-flex justify-content-between align-items-center">
          <div>
            <h2 class="h3 fw-bold mb-1">Quản lý vai trò</h2>
            <p class="text-muted small">
              Xem và chỉnh sửa danh sách vai trò và quyền hạn của từng vai trò
            </p>
          </div>
          <div class="d-flex gap-2">
            <button
              class="btn btn-sm btn-success"
              onclick="showCreatePermissionModal()"
            >
              <i class="bi bi-plus-circle"></i> Thêm quyền mới
            </button>
            <a href="/admin/user-permissions" class="btn btn-sm btn-info">
              <i class="bi bi-people"></i> Phân quyền users
            </a>
            <a href="/admin" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-arrow-left"></i> Quay lại
            </a>
          </div>
        </header>

        <!-- Roles Grid -->
        <div id="roles-container" class="row g-4">
          <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Đang tải...</span>
            </div>
          </div>
        </div>

        <!-- Permissions Reference -->
        <div class="mt-5">
          <h3 class="h5 fw-bold mb-4">Danh sách quyền hạn</h3>
          <div id="permissions-container" class="row g-3">
            <!-- Loaded via JS -->
          </div>
          <div id="permissions-pagination" class="mt-3"></div>
        </div>
      </main>
    </div>

    <!-- Create Permission Modal -->
    <div class="modal fade" id="createPermissionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content border-secondary">
          <div class="modal-header border-secondary">
            <h5 class="modal-title">Tạo quyền mới</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Permission Key *</label>
              <input
                type="text"
                class="form-control"
                id="perm-key"
                placeholder="manage_something"
              />
              <small class="text-muted"
                >Chỉ dùng chữ thường, số và dấu gạch dưới</small
              >
            </div>
            <div class="mb-3">
              <label class="form-label">Tên hiển thị *</label>
              <input
                type="text"
                class="form-control"
                id="perm-name"
                placeholder="Quản lý..."
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Mô tả</label>
              <textarea
                class="form-control"
                id="perm-desc"
                rows="2"
                placeholder="Mô tả chi tiết về quyền này"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer border-secondary">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Hủy
            </button>
            <button
              type="button"
              class="btn btn-success"
              onclick="createPermission()"
            >
              <i class="bi bi-plus-circle"></i> Tạo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Role Modal -->
    <div class="modal fade" id="editRoleModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content border-secondary">
          <div class="modal-header border-secondary">
            <h5 class="modal-title">
              Chỉnh sửa vai trò:
              <span id="edit-role-name" class="text-primary"></span>
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p class="text-muted">Chọn các quyền hạn cho vai trò này:</p>
            <div id="edit-role-permissions" class="row g-2">
              <!-- Checkboxes loaded via JS -->
            </div>
            <div
              class="alert alert-info border-info bg-info bg-opacity-10 mt-3"
            >
              <i class="bi bi-info-circle me-2"></i>
              <small
                >Lưu ý: Thay đổi quyền hạn sẽ ảnh hưởng đến tất cả users có vai
                trò này</small
              >
            </div>
          </div>
          <div class="modal-footer border-secondary">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Hủy
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveRolePermissions()"
            >
              <i class="bi bi-save"></i> Lưu thay đổi
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Permission Modal -->
    <div class="modal fade" id="editPermissionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content border-secondary">
          <div class="modal-header border-secondary">
            <h5 class="modal-title">Chỉnh sửa quyền</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Permission Key</label>
              <input
                type="text"
                class="form-control"
                id="edit-perm-key"
                readonly
                disabled
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Tên hiển thị *</label>
              <input type="text" class="form-control" id="edit-perm-name" />
            </div>
            <div class="mb-3">
              <label class="form-label">Mô tả</label>
              <textarea
                class="form-control"
                id="edit-perm-desc"
                rows="2"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer border-secondary">
            <button
              type="button"
              class="btn btn-danger"
              onclick="deletePermission()"
            >
              <i class="bi bi-trash"></i> Xóa
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Hủy
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updatePermission()"
            >
              <i class="bi bi-save"></i> Lưu
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/admin/js/sidebar.js"></script>
    <script src="/admin/js/pagination.js"></script>
    <script>
      let allRoles = {};
      let allPermissions = {};
      let currentEditingRole = null;
      let currentEditingPermKey = null;
      let createPermModal, editRoleModal, editPermModal;
      let permissionsPagination;

      async function loadData() {
        try {
          const response = await fetch("/api/admin/permissions/config");
          if (!response.ok) {
            if (response.status === 403) {
              alert("Bạn không có quyền truy cập trang này");
              window.location.href = "/admin";
              return;
            }
            throw new Error("Failed to load permissions");
          }

          const data = await response.json();
          allRoles = data.roles || {};
          allPermissions = data.permissions || {};

          renderRoles();
          renderPermissions();
        } catch (error) {
          console.error("Error loading roles:", error);
          document.getElementById("roles-container").innerHTML = `
            <div class="col-12">
              <div class="alert alert-danger">
                Lỗi khi tải dữ liệu: ${error.message}
              </div>
            </div>
          `;
        }
      }

      function renderRoles() {
        const container = document.getElementById("roles-container");
        container.innerHTML = "";

        const roleColors = {
          super_admin: "danger",
          admin: "warning",
          instructor: "info",
          teaching_assistant: "success",
          student: "secondary",
        };

        for (const [roleKey, roleData] of Object.entries(allRoles)) {
          const color = roleColors[roleKey] || "primary";
          const permList =
            roleData.permissions[0] === "*"
              ? '<span class="badge bg-danger">Toàn quyền</span>'
              : roleData.permissions
                  .map(
                    (p) =>
                      `<span class="permission-badge">${allPermissions[p]?.name || p}</span>`,
                  )
                  .join("");

          const editBtn =
            roleKey !== "super_admin"
              ? `<button class="btn btn-sm btn-outline-primary mt-2" onclick="editRole('${roleKey}')">
                 <i class="bi bi-pencil"></i> Chỉnh sửa
               </button>`
              : '<small class="text-muted mt-2 d-block">Không thể chỉnh sửa</small>';

          container.innerHTML += `
            <div class="col-md-6 col-lg-4">
              <div class="card role-card h-100 p-4 border-${color}" style="border-left-color: var(--bs-${color}) !important">
                <div class="d-flex align-items-center mb-3">
                  <i class="bi bi-shield-fill text-${color} fs-3 me-3"></i>
                  <div>
                    <h4 class="h6 fw-bold mb-0">${roleData.name}</h4>
                    <small class="text-muted">${roleKey}</small>
                  </div>
                </div>
                <p class="text-muted small mb-3">${roleData.description}</p>
                <div class="mt-auto">
                  <div class="text-muted small mb-2 fw-bold">Quyền hạn:</div>
                  <div>${permList}</div>
                  ${editBtn}
                </div>
              </div>
            </div>
          `;
        }
      }

      function renderPermissions() {
        if (!permissionsPagination) {
          permissionsPagination = new PaginationHelper(
            "permissions-pagination",
            {
              pageSize: 12,
              renderCallback: renderPermissionsPage,
            },
          );
          window.paginationInstance = permissionsPagination;
        }

        const permsArray = Object.entries(allPermissions);
        permissionsPagination.setData(permsArray);
      }

      function renderPermissionsPage(pageData) {
        const container = document.getElementById("permissions-container");
        container.innerHTML = "";

        for (const [permKey, permData] of pageData) {
          container.innerHTML += `
            <div class="col-md-6 col-lg-4">
              <div class="card perm-card p-3">
                <div class="d-flex align-items-start justify-content-between">
                  <div class="d-flex align-items-start flex-grow-1">
                    <i class="bi bi-key-fill text-primary me-3 mt-1"></i>
                    <div class="flex-grow-1">
                      <div class="fw-bold small">${permData.name}</div>
                      <div class="text-muted" style="font-size: 0.8rem">${permData.description}</div>
                      <code class="text-info" style="font-size: 0.75rem">${permKey}</code>
                    </div>
                  </div>
                  <button class="btn btn-sm btn-outline-secondary ms-2" onclick="editPermission('${permKey}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
        }
      }

      function showCreatePermissionModal() {
        document.getElementById("perm-key").value = "";
        document.getElementById("perm-name").value = "";
        document.getElementById("perm-desc").value = "";

        if (!createPermModal) {
          createPermModal = new bootstrap.Modal(
            document.getElementById("createPermissionModal"),
          );
        }
        createPermModal.show();
      }

      async function createPermission() {
        const key = document.getElementById("perm-key").value.trim();
        const name = document.getElementById("perm-name").value.trim();
        const desc = document.getElementById("perm-desc").value.trim();

        if (!key || !name) {
          alert("Vui lòng điền đầy đủ thông tin bắt buộc!");
          return;
        }

        try {
          const res = await fetch("/api/admin/permissions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ key, name, description: desc }),
          });

          const data = await res.json();
          if (res.ok) {
            alert("Tạo permission thành công!");
            createPermModal.hide();
            loadData();
          } else {
            alert("Lỗi: " + data.message);
          }
        } catch (error) {
          alert("Lỗi: " + error.message);
        }
      }

      function editRole(roleKey) {
        currentEditingRole = roleKey;
        const roleData = allRoles[roleKey];

        document.getElementById("edit-role-name").textContent = roleData.name;

        const container = document.getElementById("edit-role-permissions");
        container.innerHTML = "";

        const rolePerms = roleData.permissions || [];

        for (const [permKey, permData] of Object.entries(allPermissions)) {
          const checked = rolePerms.includes(permKey);
          container.innerHTML += `
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input role-perm-checkbox" type="checkbox" 
                       value="${permKey}" ${checked ? "checked" : ""} id="role-perm-${permKey}">
                <label class="form-check-label" for="role-perm-${permKey}">
                  ${permData.name}
                  <div class="text-muted small">${permData.description}</div>
                </label>
              </div>
            </div>
          `;
        }

        if (!editRoleModal) {
          editRoleModal = new bootstrap.Modal(
            document.getElementById("editRoleModal"),
          );
        }
        editRoleModal.show();
      }

      async function saveRolePermissions() {
        const checkboxes = document.querySelectorAll(".role-perm-checkbox");
        const permissions = Array.from(checkboxes)
          .filter((cb) => cb.checked)
          .map((cb) => cb.value);

        try {
          const res = await fetch(
            `/api/admin/roles/${currentEditingRole}/permissions`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ permissions }),
            },
          );

          const data = await res.json();
          if (res.ok) {
            alert("Cập nhật thành công!");
            editRoleModal.hide();
            loadData();
          } else {
            alert("Lỗi: " + data.message);
          }
        } catch (error) {
          alert("Lỗi: " + error.message);
        }
      }

      function editPermission(permKey) {
        currentEditingPermKey = permKey;
        const permData = allPermissions[permKey];

        document.getElementById("edit-perm-key").value = permKey;
        document.getElementById("edit-perm-name").value = permData.name;
        document.getElementById("edit-perm-desc").value = permData.description;

        if (!editPermModal) {
          editPermModal = new bootstrap.Modal(
            document.getElementById("editPermissionModal"),
          );
        }
        editPermModal.show();
      }

      async function updatePermission() {
        const name = document.getElementById("edit-perm-name").value.trim();
        const desc = document.getElementById("edit-perm-desc").value.trim();

        if (!name) {
          alert("Vui lòng điền tên hiển thị!");
          return;
        }

        try {
          const res = await fetch(
            `/api/admin/permissions/${currentEditingPermKey}`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, description: desc }),
            },
          );

          const data = await res.json();
          if (res.ok) {
            alert("Cập nhật thành công!");
            editPermModal.hide();
            loadData();
          } else {
            alert("Lỗi: " + data.message);
          }
        } catch (error) {
          alert("Lỗi: " + error.message);
        }
      }

      async function deletePermission() {
        if (
          !confirm(
            `Bạn có chắc muốn xóa permission "${currentEditingPermKey}"?`,
          )
        ) {
          return;
        }

        try {
          const res = await fetch(
            `/api/admin/permissions/${currentEditingPermKey}`,
            {
              method: "DELETE",
            },
          );

          const data = await res.json();
          if (res.ok) {
            alert("Xóa thành công!");
            editPermModal.hide();
            loadData();
          } else {
            alert("Lỗi: " + data.message);
          }
        } catch (error) {
          alert("Lỗi: " + error.message);
        }
      }

      document.addEventListener("DOMContentLoaded", loadData);
    </script>
  </body>
</html>
