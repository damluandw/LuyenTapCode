<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tạo kỳ thi - Admin</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/sinhvien/css/student-bs5.css" />
    <link rel="stylesheet" href="/admin/css/admin.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .problem-list-box {
        background: rgba(13, 17, 23, 0.4);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        height: 400px;
        overflow-y: auto;
      }
      .prob-item {
        padding: 12px 16px;
        margin: 8px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--glass-border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .prob-item:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: var(--accent);
      }
      .prob-item.selected {
        border-color: var(--accent);
        background: rgba(88, 166, 255, 0.08);
      }
      .selected-badge {
        background: var(--accent);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        box-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
      }
      .form-label-custom {
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
      }
    </style>
  </head>
  <body class="bg-dark text-light">
    <div class="container py-5">
      <header class="mb-5 d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h2 fw-bold text-white mb-1" id="page-title">
            Tạo kỳ thi mới
          </h1>
          <p class="text-muted">
            Thiết lập thông tin, thời gian và bài tập cho kỳ thi
          </p>
        </div>
        <button
          class="btn btn-outline-secondary px-4"
          onclick="location.href = '/admin/exams'"
        >
          <i class="bi bi-arrow-left me-1"></i> Quay lại
        </button>
      </header>

      <!-- Basic Info Card -->
      <div class="card shadow-sm mb-4 border-0 p-4">
        <h3 class="h5 fw-bold text-white mb-4">
          <i class="bi bi-info-circle me-2 text-info"></i>Thông tin cơ bản
        </h3>

        <div class="mb-4">
          <label class="form-label-custom">Tên kỳ thi</label>
          <input
            type="text"
            id="exam-title"
            class="form-control bg-dark border-secondary text-light p-3"
            placeholder="Ví dụ: Kiểm tra giữa kỳ môn Python"
          />
        </div>

        <div class="row g-4 mb-4">
          <div class="col-md-6">
            <label class="form-label-custom">Thời gian làm bài (phút)</label>
            <input
              type="number"
              id="exam-duration"
              class="form-control bg-dark border-secondary text-light p-3"
              value="60"
            />
          </div>
          <div class="col-md-6">
            <label class="form-label-custom">Trạng thái</label>
            <select
              id="exam-active"
              class="form-select bg-dark border-secondary text-light p-3"
            >
              <option value="true">Đang mở (Active)</option>
              <option value="false">Đang khóa (Inactive)</option>
            </select>
          </div>
        </div>

        <div class="row g-4 mb-4">
          <div class="col-md-6">
            <label class="form-label-custom"
              >Mở đề lúc (Thời gian thực hành)</label
            >
            <input
              type="datetime-local"
              id="exam-open"
              class="form-control bg-dark border-secondary text-light p-3"
            />
          </div>
          <div class="col-md-6">
            <label class="form-label-custom">Đóng đề lúc</label>
            <input
              type="datetime-local"
              id="exam-close"
              class="form-control bg-dark border-secondary text-light p-3"
            />
          </div>
        </div>

        <div>
          <label class="form-label-custom d-block"
            >Ngôn ngữ cho phép (Trống = Tất cả)</label
          >
          <div
            class="d-flex gap-4 flex-wrap mt-2 p-3 bg-dark bg-opacity-25 rounded-3 border border-secondary border-opacity-25"
          >
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                name="allowed-lang"
                value="python"
                id="lang-py"
              />
              <label class="form-check-label text-light" for="lang-py"
                >Python</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                name="allowed-lang"
                value="cpp"
                id="lang-cpp"
              />
              <label class="form-check-label text-light" for="lang-cpp"
                >C++</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                name="allowed-lang"
                value="c"
                id="lang-c"
              />
              <label class="form-check-label text-light" for="lang-c">C</label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                name="allowed-lang"
                value="java"
                id="lang-java"
              />
              <label class="form-check-label text-light" for="lang-java"
                >Java</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                name="allowed-lang"
                value="csharp"
                id="lang-cs"
              />
              <label class="form-check-label text-light" for="lang-cs"
                >C#</label
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Problem Selection Card -->
      <div class="card shadow-sm mb-5 border-0 p-4">
        <h3 class="h5 fw-bold text-white mb-4">
          <i class="bi bi-list-check me-2 text-warning"></i>Chọn bài tập cho kỳ
          thi
        </h3>

        <div class="row g-4">
          <div class="col-lg-6">
            <p class="text-muted small fw-bold text-uppercase mb-3">
              Ngân hàng bài tập
            </p>
            <div id="all-problems-list" class="problem-list-box p-2">
              <div class="text-center text-muted p-5">
                Đang tải danh sách bài tập...
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <p class="text-muted small fw-bold text-uppercase mb-3">
              Bài tập đã chọn (<span id="selected-count" class="text-info"
                >0</span
              >)
            </p>
            <div id="selected-problems-list" class="problem-list-box p-2">
              <div class="text-center text-muted p-5 italic">
                Chưa chọn bài tập nào
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="sticky-bottom py-3 bg-dark border-top border-secondary border-opacity-25 mt-5"
      >
        <div class="d-flex justify-content-end gap-3">
          <button
            class="btn btn-lg btn-outline-secondary px-5"
            onclick="location.href = '/admin/exams'"
          >
            Hủy bỏ
          </button>
          <button
            id="save-exam-btn"
            class="btn btn-lg btn-primary px-5 fw-bold shadow-lg"
          >
            <i class="bi bi-save me-2"></i> Lưu kỳ thi
          </button>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <script>
      let allProblems = [];
      let selectedProblemIds = [];
      let problemPoints = {};
      let examId = new URLSearchParams(window.location.search).get("id");

      async function init() {
        try {
          const res = await fetch("/problems");
          allProblems = await res.json();

          if (examId) {
            document.getElementById("page-title").textContent =
              "Chỉnh sửa kỳ thi";
            const examRes = await fetch(`/api/admin/exams/${examId}`);
            if (examRes.ok) {
              const exam = await examRes.json();
              document.getElementById("exam-title").value = exam.title;
              document.getElementById("exam-duration").value = exam.duration;
              document.getElementById("exam-active").value =
                exam.isActive.toString();
              if (exam.openTime)
                document.getElementById("exam-open").value = exam.openTime;
              if (exam.closeTime)
                document.getElementById("exam-close").value = exam.closeTime;

              selectedProblemIds = exam.problemIds || [];
              problemPoints = exam.problemPoints || {};

              if (exam.allowedLanguages && exam.allowedLanguages.length > 0) {
                document
                  .querySelectorAll('input[name="allowed-lang"]')
                  .forEach((cb) => {
                    if (exam.allowedLanguages.includes(cb.value)) {
                      cb.checked = true;
                    }
                  });
              }
            }
          }
          renderLists();
        } catch (e) {
          console.error("Initialization error:", e);
        }
      }

      function renderLists() {
        const allList = document.getElementById("all-problems-list");
        const selectedList = document.getElementById("selected-problems-list");

        allList.innerHTML = "";
        selectedList.innerHTML = "";

        allProblems.forEach((p) => {
          const isSelected = selectedProblemIds.includes(p.id);

          // All list item
          const item = document.createElement("div");
          item.className = `prob-item d-flex justify-content-between align-items-center ${isSelected ? "selected" : ""}`;
          item.innerHTML = `
            <span class="text-white">${p.title}</span>
            ${isSelected ? '<div class="selected-badge"><i class="bi bi-check-lg"></i></div>' : '<i class="bi bi-plus-lg text-muted"></i>'}
          `;
          item.onclick = () => toggleProblem(p.id);
          allList.appendChild(item);

          // Selected list item
          if (isSelected) {
            const selItem = document.createElement("div");
            selItem.className = "prob-item d-flex flex-column gap-2";
            selItem.style.cursor = "default";
            if (!problemPoints[p.id]) problemPoints[p.id] = 10;

            selItem.innerHTML = `
              <div class="d-flex justify-content-between">
                <span class="text-white fw-bold">${p.title}</span>
                <button onclick="toggleProblem(${p.id})" class="btn btn-link btn-sm text-danger p-0 border-0">
                  <i class="bi bi-x-circle-fill h5 mb-0"></i>
                </button>
              </div>
              <div class="d-flex align-items-center gap-2 mt-1">
                <span class="text-muted small">Điểm:</span>
                <input type="number" 
                  class="form-control form-control-sm bg-dark border-secondary text-info text-center fw-bold" 
                  style="width: 70px"
                  value="${problemPoints[p.id]}" 
                  onchange="updatePoint(${p.id}, this.value)">
              </div>
            `;
            selectedList.appendChild(selItem);
          }
        });

        if (selectedProblemIds.length === 0) {
          selectedList.innerHTML =
            '<div class="text-center text-muted p-5 italic">Chưa chọn bài tập nào</div>';
        }

        document.getElementById("selected-count").textContent =
          selectedProblemIds.length;
      }

      function toggleProblem(id) {
        if (selectedProblemIds.includes(id)) {
          selectedProblemIds = selectedProblemIds.filter((pid) => pid !== id);
          delete problemPoints[id];
        } else {
          selectedProblemIds.push(id);
          problemPoints[id] = 10;
        }
        renderLists();
      }

      function updatePoint(id, val) {
        problemPoints[id] = parseInt(val) || 0;
      }

      document.getElementById("save-exam-btn").onclick = async () => {
        const title = document.getElementById("exam-title").value;
        const duration = document.getElementById("exam-duration").value;
        const isActive =
          document.getElementById("exam-active").value === "true";
        const openTime = document.getElementById("exam-open").value;
        const closeTime = document.getElementById("exam-close").value;

        if (!title || selectedProblemIds.length === 0) {
          alert("Vui lòng nhập tên kỳ thi và chọn ít nhất 1 bài tập.");
          return;
        }

        const allowedLanguages = Array.from(
          document.querySelectorAll('input[name="allowed-lang"]:checked'),
        ).map((cb) => cb.value);

        const payload = {
          title,
          duration: parseInt(duration),
          problemIds: selectedProblemIds,
          problemPoints: problemPoints,
          isActive: isActive,
          openTime: openTime,
          closeTime: closeTime,
          allowedLanguages: allowedLanguages,
        };

        const url = examId ? `/api/admin/exams/${examId}` : "/api/admin/exams";
        const method = examId ? "PUT" : "POST";

        try {
          const res = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (res.ok) {
            alert(
              examId
                ? "Đã cập nhật kỳ thi thành công!"
                : "Đã tạo kỳ thi thành công!",
            );
            location.href = "/admin/exams";
          } else {
            alert("Có lỗi xảy ra khi lưu kỳ thi.");
          }
        } catch (e) {
          alert("Lỗi kết nối máy chủ.");
        }
      };

      init();
    </script>
  </body>
</html>
